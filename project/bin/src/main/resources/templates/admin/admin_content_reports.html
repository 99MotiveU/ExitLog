<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ExitLog - ì‹ ê³  ê´€ë¦¬</title>
    <link rel="stylesheet" th:href="@{/css/layoutcss.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body>
    <main>
      <div class="admin-content-title">ğŸš¨ ì‹ ê³ ëœ ê²Œì‹œê¸€ ê´€ë¦¬</div>
      <div class="admin-list-container">
        <div class="flex-table-header">
          <div class="col-log-id">ê¸€ ID</div>
          <div class="col-log-title">ì œëª©</div>
          <div class="col-log-company">íšŒì‚¬ëª…</div>
          <div class="col-log-author">ì‘ì„±ì</div>
          <div class="col-log-repo-count">ì‹ ê³ ìˆ˜</div>
          <div class="col-log-date">ì‘ì„±ì¼</div>
        </div>
        <!-- ê²Œì‹œê¸€ ì—†ìŒ -->
        <th:block th:if="${reportedLogsList == null or #lists.isEmpty(reportedLogsList)}" >
          <div class="flex-table-row">
            <div
              style="
                text-align: center;
                padding: 20px;
                flex-grow: 1;
                color: #6c757d;
              "
            >
              ì‹ ê³ ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </th:block>

        <th:block th:unless="${reportedLogsList == null or #lists.isEmpty(reportedLogsList)}">
          <div class="flex-table-row" th:each="logEntry : ${reportedLogsList}">
            <div class="col-log-id" th:text="${logEntry.logNo}">-</div>
            <div class="col-log-title">
              <span th:text="${logEntry.title}"
                class="report-log-title-action"
                data-toggle="modal" 
                data-target="#reportProcessModal" th:attr="data-logno=${logEntry.logNo}, 
                         data-logtitle=${logEntry.title}, 
                         data-repocount=${logEntry.repoCount}">
              </span>
            </div>
            <div class="col-log-company" th:text="${logEntry.companyName ?: '-'}">-</div>
            <div class="col-log-author" th:text="${logEntry.nickname ?: logEntry.userNo}">-</div>
            <div class="col-log-repo-count" th:text="${logEntry.repoCount}">0</div>
            <div class="col-log-date" th:text="${logEntry.createdDate != null ? #dates.format(logEntry.createdDate, 'yyyy-MM-dd') : '-'}">-</div>
            </div>
        </th:block>
      </div>

      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      <nav th:if="${pagination != null && pagination.maxPage > 0}" 
           aria-label="Page navigation" 
           class="d-flex justify-content-center mt-4 admin-pagination">
        <ul class="pagination">
            <li class="page-item" th:classappend="${pagination.currentPage == 1} ? 'disabled' : ''"><a class="page-link" th:href="@{/admin/reports(page=1, limit=${pagination.limit}, pageSize=${pagination.pageSize})}"><i class="fa-solid fa-backward"></i><span class="sr-only">First</span></a></li>
            <li class="page-item" th:classappend="${pagination.currentPage == 1} ? 'disabled' : ''"><a class="page-link" th:href="@{/admin/reports(page=${pagination.prevPage}, limit=${pagination.limit}, pageSize=${pagination.pageSize})}"><i class="fa-solid fa-caret-left"></i><span class="sr-only">Previous</span></a></li>
            <li th:each="pageNum : ${#numbers.sequence(pagination.startPage, pagination.endPage)}" class="page-item" th:classappend="${pageNum == pagination.currentPage} ? 'active' : ''"><a class="page-link" th:href="@{/admin/reports(page=${pageNum}, limit=${pagination.limit}, pageSize=${pagination.pageSize})}" th:text="${pageNum}">1</a></li>
            <li class="page-item" th:classappend="${pagination.currentPage == pagination.maxPage} ? 'disabled' : ''"><a class="page-link" th:href="@{/admin/reports(page=${pagination.nextPage}, limit=${pagination.limit}, pageSize=${pagination.pageSize})}"><i class="fa-solid fa-caret-right"></i><span class="sr-only">Next</span></a></li>
            <li class="page-item" th:classappend="${pagination.currentPage == pagination.maxPage} ? 'disabled' : ''"><a class="page-link" th:href="@{/admin/reports(page=${pagination.maxPage}, limit=${pagination.limit}, pageSize=${pagination.pageSize})}"><i class="fa-solid fa-forward"></i><span class="sr-only">Last</span></a></li>
        </ul>
      </nav>

      <!-- ëª¨ë‹¬ -->
      <div class="modal fade" id="reportProcessModal" tabindex="-1" aria-labelledby="reportProcessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"> <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="reportProcessModalLabel">ì‹ ê³  ë‚´ì—­ ë° ì²˜ë¦¬ 
                <span class="modal-title-log-info">(ê¸€ ID: <span id="modalProcessLogId"></span>)</span>
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="currentProcessLogNo" value=""/>
                <div class="d-flex justify-content-start">
                  <div class="p-2 mr-2"><strong>ê²Œì‹œê¸€ ì œëª©</strong></div>
                  <div class="p-2"><span id="modalProcessLogTitle"></span></div>
                  <div class="p-2"><a href="#" id="modalViewPostLink" target="_blank" class="ml-2 badge badge-success">ê²Œì‹œê¸€ ë‚´ìš© ë³´ê¸°</a></div>
                </div>
                <div class="d-flex justify-content-start">
                  <div class="p-2 mr-2"><strong>ì´ ì‹ ê³  íšŸìˆ˜</strong></div>
                  <div class="p-2 "><strong id="modalProcessRepoCount" class="text-danger"></strong></div>
                </div>
              <hr>
              <h6><strong>ì‹ ê³  ì‚¬ìœ  ëª©ë¡:</strong></h6>
              <ul id="modalReportReasonList" class="report-reason-list">
                <li class="text-muted">ì‹ ê³  ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
              </ul>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
              <button type="button" class="btn btn-warning" id="processDismissButton">ë³´ë¥˜ (ì‹ ê³  ìˆ˜ ë¦¬ì…‹)</button>
              <button type="button" class="btn btn-danger" id="processDeleteButton">ê²Œì‹œê¸€ ì‚­ì œ</button>
            </div>
          </div>
        </div>
      </div>

      <form
        id="deleteLogPostForm"
        method="POST"
        style="display: none"
        th:action="@{/}"
      >
        <input
          type="hidden"
          th:name="${_csrf?.parameterName}"
          th:value="${_csrf?.token}"
        />
      </form>
      <form
        id="dismissReportsPostForm"
        method="POST"
        style="display: none"
        th:action="@{/}"
      >
        <input
          type="hidden"
          th:name="${_csrf?.parameterName}"
          th:value="${_csrf?.token}"
        />
      </form>

      <script th:inline="javascript">
        /*<![CDATA[*/
        // CSRF í† í° ë° í—¤ë”ëª… ì „ì—­ ë³€ìˆ˜ (AJAX ìš”ì²­ ì‹œ ì‚¬ìš©)
        window.csrfToken = /*[[${_csrf?.token}]]*/ null;
        window.csrfHeaderName = /*[[${_csrf?.headerName}]]*/ null;
        $(document).ready(function () {
          // â­ ì‹ ê·œ: ì œëª©(span) í´ë¦­ ì‹œ ì‹ ê³  ì²˜ë¦¬ ëª¨ë‹¬ ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ
        $('.report-log-title-action').on('click', function() {
            const logNo = $(this).data('logno'); // â­ data-lognoì—ì„œ ê°’ì„ ê°€ì ¸ì˜´
            const logTitle = $(this).data('logtitle');
            const repoCount = $(this).data('repocount');
            //const logNo = $(this).data('log-id'); // data-log-id ì‚¬ìš© (ì´ì „ ì½”ë“œì—ì„œëŠ” data-logno ì˜€ìŒ, ì¼ê´€ì„± ìˆê²Œ ìˆ˜ì •)
            // const logTitle = $(this).data('log-title');
            // const repoCount = $(this).data('log-repo-count');

            console.log("ëª¨ë‹¬ íŠ¸ë¦¬ê±°: logNo=", logNo, "íƒ€ì…:", typeof logNo); // â­ logNo ê°’ê³¼ íƒ€ì… í™•ì¸

            // logNoê°€ undefined ë˜ëŠ” nullì´ ì•„ë‹Œì§€ í™•ì¸
            if (logNo === undefined || logNo === null || String(logNo).trim() === "") { // â­ ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”
                console.error('í´ë¦­ëœ í•­ëª©ì—ì„œ ìœ íš¨í•œ logNoë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. data-logno ì†ì„± ë° ê°’ì„ í™•ì¸í•˜ì„¸ìš”.');
                alert('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (logNo ëˆ„ë½). ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                // ëª¨ë‹¬ì´ ì´ë¯¸ ë–´ë‹¤ë©´, ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ëª¨ë‹¬ ë‚´ë¶€ì— í‘œì‹œí•˜ê³  ë‹«ì„ ìˆ˜ë„ ìˆìŒ
                $('#modalReportReasonList').html('<li class="text-danger p-2">ê²Œì‹œê¸€ ì •ë³´(ID)ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>');
                return; 
            }

            console.log("ëª¨ë‹¬ íŠ¸ë¦¬ê±°: logNo=", logNo, "logTitle=", logTitle, "repoCount=", repoCount); // â­ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

            $('#currentProcessLogNo').val(logNo);
            $('#modalProcessLogId').text(logNo);
            $('#modalProcessLogTitle').text(logTitle);
            $('#modalProcessRepoCount').text(repoCount);
            
            // â­ ëª¨ë‹¬ ë‚´ "ê²Œì‹œê¸€ ë‚´ìš© ë³´ê¸°" ë§í¬ URL ì„¤ì •
            $('#modalViewPostLink').attr('href', '/log/' + logNo);
            
            $('#modalReportReasonList').html('<li class="text-muted">ì‹ ê³  ì‚¬ìœ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>');
            loadReportDetailsForModal(logNo);

            // â­ loadReportDetailsForModal í•¨ìˆ˜ì— ìœ íš¨í•œ logNo ì „ë‹¬ í™•ì¸
            loadReportDetailsForModal(logNo); 
            
            // data-toggle="modal" data-target="#reportProcessModal" ì†ì„±ì´ spanì— ìˆìœ¼ë¯€ë¡œ ëª¨ë‹¬ì€ ìë™ìœ¼ë¡œ ëœ¸
        });

        // â­ ìˆ˜ì •: ì‹ ê³  ì‚¬ìœ  ëª©ë¡ì„ AJAXë¡œ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
      function loadReportDetailsForModal(logNo) {
        // â­ logNoê°€ undefinedë¡œ ë“¤ì–´ì˜¤ëŠ”ì§€ ì—¬ê¸°ì„œë„ í™•ì¸ ê°€ëŠ¥
          console.log(`loadReportDetailsForModal í˜¸ì¶œë¨. logNo: ${logNo}`); 
          
          if (typeof logNo === 'undefined' || logNo === null) {
            console.error('loadReportDetailsForModal: ìœ íš¨í•˜ì§€ ì•Šì€ logNo ê°’ìœ¼ë¡œ í˜¸ì¶œë¨:', logNo);
            $('#modalReportReasonList').html('<li class="text-danger p-2">ì˜ëª»ëœ ê²Œì‹œê¸€ ì •ë³´ë¡œ ì‹ ê³  ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>');
            return;
          }

          const $reportReasonList = $('#modalReportReasonList');
          $reportReasonList.html('<li class="text-muted p-2">ì‹ ê³  ì‚¬ìœ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>'); 

          console.log(`ê²Œì‹œê¸€ ID ${logNo}ì˜ ì‹ ê³  ìƒì„¸ ë‚´ì—­ì„ AJAXë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.`);

          $.ajax({
              url: `/api/reports/log/${logNo}/details`, // â­ ë°±ì—”ë“œ API ê²½ë¡œì™€ ì¼ì¹˜í•´ì•¼ í•¨
              type: 'GET',
              dataType: 'json', // ì„œë²„ê°€ JSONì„ ë°˜í™˜í•  ê²ƒìœ¼ë¡œ ê¸°ëŒ€
              beforeSend: function(xhr) {
                  // CSRF í† í°ì€ GET ìš”ì²­ì—ëŠ” í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ, ì¼ê´€ì„±ì„ ìœ„í•´ ë˜ëŠ” POST ë“± ë‹¤ë¥¸ ìš”ì²­ì— í•„ìš”í•  ìˆ˜ ìˆìŒ
                  if (window.csrfHeaderName && window.csrfToken) {
                      // xhr.setRequestHeader(window.csrfHeaderName, window.csrfToken); // GETì—ëŠ” ë³´í†µ ë¶ˆí•„ìš”
                  }
              },
              success: function(reportItems) { // reportItemsëŠ” List<ReportItemDto> í˜•íƒœì˜ JSON ë°°ì—´
                  $reportReasonList.empty(); // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°
                  if (reportItems && reportItems.length > 0) {
                      // ì´ ì‹ ê³  íšŸìˆ˜ë¥¼ ì—¬ê¸°ì„œ ë‹¤ì‹œ ì •í™•í•˜ê²Œ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                      // $('#modalProcessRepoCount').text(reportItems.length); // ë˜ëŠ” ì„œë²„ì—ì„œ ì´ ì‹ ê³  íšŸìˆ˜ë¥¼ ë³„ë„ë¡œ ë°›ì•„ì™€ë„ ë¨

                      reportItems.forEach(function(report) {
                          const reportDate = report.repoDate ? new Date(report.repoDate).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';
                          const listItem = `<li>
                                              <span class="reason-text">${escapeHTML(report.repoReason)}</span>
                                              <span class="reason-meta">
                                                (ì‹ ê³ ì: ${escapeHTML(report.reporterNickname || 'ìµëª…')}, 
                                                 ë‚ ì§œ: ${reportDate})
                                              </span>
                                            </li>`;
                          $reportReasonList.append(listItem);
                      });
                  } else {
                      $reportReasonList.append('<li class="text-muted p-2">ì´ ê²Œì‹œê¸€ì— ëŒ€í•œ ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>');
                  }
              },
              error: function(xhr, status, error) {
                  console.error("ì‹ ê³  ìƒì„¸ ë‚´ì—­ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", status, error, xhr.responseText);
                  $reportReasonList.html('<li class="text-danger p-2">ì‹ ê³  ì‚¬ìœ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</li>');
              }
          });
      }
        
        // â­ ìˆ˜ì •: ëª¨ë‹¬ ë‚´ "ê²Œì‹œê¸€ ì‚­ì œ" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      $('#processDeleteButton').on('click', function() {
          const logNo = $('#currentProcessLogNo').val();
          if (!logNo) { 
              alert('ì²˜ë¦¬í•  ê²Œì‹œê¸€ì˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); 
              return; 
          }
          
          if (confirm(`ì •ë§ ì´ ê²Œì‹œê¸€(ID: ${logNo})ì„ ì‚­ì œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
              console.log(`ê²Œì‹œê¸€ ID ${logNo} ì‚­ì œ ì²˜ë¦¬ AJAX ìš”ì²­`);
              
              $.ajax({
                  url: `/api/admin/reports/log/${logNo}/delete`, // â­ ë°±ì—”ë“œ ì‚­ì œ API ê²½ë¡œ í™•ì¸!
                  type: 'POST', // ë˜ëŠ” ì„œë²„ APIê°€ @DeleteMappingì„ ì‚¬ìš©í•œë‹¤ë©´ 'DELETE'
                  // dataType: 'json', // ì„œë²„ê°€ JSONì„ ë°˜í™˜í•œë‹¤ë©´ ëª…ì‹œ
                  beforeSend: function(xhr) {
                      // CSRF í† í° í—¤ë” ì¶”ê°€
                      if (window.csrfHeaderName && window.csrfToken) {
                          xhr.setRequestHeader(window.csrfHeaderName, window.csrfToken);
                      } else {
                          console.warn('CSRF í† í° ë˜ëŠ” í—¤ë” ì´ë¦„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                      }
                  },
                  success: function(response) {
                      // ì„œë²„ ì‘ë‹µì´ ê°ì²´ í˜•íƒœì´ê³  message í•„ë“œê°€ ìˆë‹¤ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ ê¸°ë³¸ ë©”ì‹œì§€
                      alert(response.message || 'ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                      $('#reportProcessModal').modal('hide'); // ëª¨ë‹¬ ë‹«ê¸°
                      location.reload(); // â­ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                  },
                  error: function(xhr, status, error) {
                      console.error("ê²Œì‹œê¸€ ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", status, error, xhr.responseText);
                      let errorMessage = "ê²Œì‹œê¸€ ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                      if (xhr.responseJSON && xhr.responseJSON.message) {
                          errorMessage += "\n" + xhr.responseJSON.message;
                      } else if (xhr.responseText) {
                          // ì„œë²„ê°€ JSONì´ ì•„ë‹Œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê²½ìš°
                          try {
                              const errorResponse = JSON.parse(xhr.responseText);
                              if (errorResponse.message) errorMessage += "\n" + errorResponse.message;
                          } catch(e) {
                              // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì‘ë‹µ í…ìŠ¤íŠ¸ ì¼ë¶€ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŒ
                              // errorMessage += "\n" + xhr.responseText.substring(0, 100); 
                          }
                      }
                      alert(errorMessage);
                  }
              });
          }
      });

        // â­ ìˆ˜ì •: ëª¨ë‹¬ ë‚´ "ë³´ë¥˜ (ì‹ ê³  ìˆ˜ ë¦¬ì…‹)" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      $('#processDismissButton').on('click', function() {
          const logNo = $('#currentProcessLogNo').val();
          if (!logNo) { 
              alert('ì²˜ë¦¬í•  ê²Œì‹œê¸€ì˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); 
              return; 
          }

          if (confirm(`ì´ ê²Œì‹œê¸€(ID: ${logNo})ì˜ ì‹ ê³  ë‚´ì—­ì„ ë³´ë¥˜ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              console.log(`ê²Œì‹œê¸€ ID ${logNo} ì‹ ê³  ë³´ë¥˜(ë¦¬ì…‹) ì²˜ë¦¬ AJAX ìš”ì²­`);
              
              $.ajax({
                  url: `/api/admin/reports/log/${logNo}/dismiss`, // â­ ë°±ì—”ë“œ ë³´ë¥˜ API ê²½ë¡œ
                  type: 'POST',
                  beforeSend: function(xhr) {
                      if (window.csrfHeaderName && window.csrfToken) {
                          xhr.setRequestHeader(window.csrfHeaderName, window.csrfToken);
                      }
                  },
                  success: function(response) {
                      alert(response.message || 'ê²Œì‹œê¸€ ì‹ ê³ ê°€ ë³´ë¥˜ ì²˜ë¦¬ë˜ê³  ì‹ ê³  ìˆ˜ê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.');
                      $('#reportProcessModal').modal('hide');
                      location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                  },
                  error: function(xhr, status, error) {
                      console.error("ì‹ ê³  ë³´ë¥˜(ë¦¬ì…‹) ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", status, error, xhr.responseText);
                      let errorMessage = "ì‹ ê³  ë³´ë¥˜(ë¦¬ì…‹) ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                      if (xhr.responseJSON && xhr.responseJSON.message) {
                          errorMessage += "\n" + xhr.responseJSON.message;
                      }
                      alert(errorMessage);
                  }
              });
          }
        });

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€ìš©)
        function escapeHTML(str) {
            if (str === null || typeof str === 'undefined') return '';
            return String(str).replace(/[&<>"']/g, function (match) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;'};
                return map[match];
            });
        }
        });

        /*]]>*/
      </script>
    </main>
  </body>
</html>
