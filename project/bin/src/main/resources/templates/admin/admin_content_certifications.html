<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ExitLog</title>

    <!-- css-->
    <link rel="stylesheet" th:href="@{/css/layoutcss.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />

    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Pretendard Font -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>

  <body>
    <main>
      <div class="admin-content-title">🗂️ 회원 재직 인증 관리</div>

      <div class="admin-list-container">
        <div class="flex-table-header">
          <div class="col-member-no">회원번호</div>
          <div class="col-cert-userid">회원 아이디</div>
          <div class="col-cert-company">회사명</div>
          <div class="col-join-date">가입일</div>
          <div class="col-cert-date">요청일</div>
          <div class="col-cert-status">상태</div>
          <div class="col-cert-action">서류확인</div>
        </div>

        <th:block th:if="${#lists.isEmpty(certifications)}">
          <div class="flex-table-row">
            <div
              style="
                text-align: center;
                padding: 20px;
                flex-grow: 1;
                color: #6c757d;
              "
            >
              재직 인증 요청이 없습니다.
            </div>
          </div>
        </th:block>

        <th:block th:each="cert : ${certifications}">
          <div class="flex-table-row">
            <div class="col-member-no" th:text="${cert.userNo}">USER000</div>
            <div class="col-cert-userid" th:text="${cert.userId}">userid</div>
            <div class="col-cert-company" th:text="${cert.companyName}">
              회사명
            </div>
            <div class="col-join-date" th:text="${cert.userCreatedDate}">
              2024-01-01
            </div>
            <div class="col-cert-date" th:text="${cert.certificateUploadDate}">
              2024-05-01
            </div>
            <div class="col-cert-status">
              <span
                class="badge"
                th:classappend="${cert.statusBadgeClass}"
                th:text="${cert.statusText}"
                >상태값</span
              >
            </div>
            <div class="col-cert-action">
              <button
                type="button"
                class="btn btn-sm"
                th:classappend="${cert.status == 'PENDING' ? 'btn-primary' : 'btn-outline-secondary'}"
                data-toggle="modal"
                data-target="#certificationProcessModal"
                th:attr="data-certification-id=${cert.certificateNo},
                       data-member-no=${cert.userNo}, 
                       data-user-id=${cert.userId},
                       data-company-name=${cert.companyName},
                       data-join-date=${cert.userCreatedDate},
                       data-request-date=${cert.certificateUploadDate},
                       data-document-name=${cert.documentName},
                       data-document-url=${cert.documentWebUrl}"
              >
                <th:block
                  th:text="${cert.status == 'PENDING' ? '확인' : '보기'}"
                  >확인/보기</th:block
                >
              </button>
            </div>
          </div>
        </th:block>
      </div>

      <div
        class="modal fade"
        id="certificationProcessModal"
        tabindex="-1"
        aria-labelledby="certificationProcessModalLabel"
        aria-hidden="true"
      >
        <div
          class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
        >
          <div class="modal-content">
            <div class="modal-header" style="background-color: #f8f9fa">
              <h5
                class="modal-title"
                id="certificationProcessModalLabel"
                style="font-weight: 600"
              >
                재직 인증 처리
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="info-group">
                <span class="info-label">회원 아이디</span>
                <span class="info-value" id="modalCertUserId"></span>
              </div>
              <div class="info-group">
                <span class="info-label">회사명</span>
                <span class="info-value" id="modalCertCompany"></span>
              </div>
              <div class="info-group">
                <span class="info-label">요청 날짜</span>
                <span class="info-value" id="modalCertRequestDate"></span>
              </div>
              <div class="certification-documents">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333">
                  제출 서류
                </div>
                <div id="modalCertDocuments" class="document-list"></div>
              </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa">
              <input type="hidden" id="modalCertificationId" value="" />
              <button
                type="button"
                class="btn btn-danger btn-sm"
                onclick="handleCertificationAction('REJECTED')"
              >
                반려
              </button>
              <button
                type="button"
                class="btn btn-primary btn-sm"
                onclick="handleCertificationAction('APPROVED')"
              >
                인증
              </button>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                data-dismiss="modal"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        class="modal fade image-zoom-modal"
        id="imageZoomModal"
        tabindex="-1"
        aria-labelledby="imageZoomModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div
            class="modal-content"
            style="background: transparent; border: none"
          >
            <div
              class="modal-header"
              style="
                border-bottom: none;
                padding: 0.5rem 1rem;
                position: absolute;
                top: 0;
                right: 0;
                z-index: 1051;
              "
            >
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
                style="
                  color: white;
                  opacity: 1;
                  font-size: 2.5rem;
                  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
                "
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <img src="" id="zoomedImage" alt="확대 이미지" />
            </div>
          </div>
        </div>
      </div>

      <form
        id="certificationActionForm"
        method="POST"
        style="display: none"
        th:action="@{/admin/certifications/process}"
      >
        <input
          type="hidden"
          th:name="${_csrf?.parameterName}"
          th:value="${_csrf?.token}"
        />
        <input
          type="hidden"
          name="certificationId"
          id="formCertificationId"
          value=""
        />
        <input type="hidden" name="newStatus" id="formNewStatus" value="" />
      </form>

      <!-- 페이지네이션 -->
      <nav
        th:if="${pagination != null && pagination.maxPage > 0}"
        aria-label="Page navigation"
        class="d-flex justify-content-center mt-4 admin-pagination"
      >
        <ul class="pagination">
          <li
            class="page-item"
            th:classappend="${pagination.currentPage == 1} ? 'disabled' : ''"
          >
            <a
              class="page-link"
              th:href="@{/admin/certifications(page=1, limit=${pagination.limit}, pageSize=${pagination.pageSize}, sort=${currentSort})}"
            >
              <i class="fa-solid fa-backward"></i>
              <span class="sr-only">First</span>
            </a>
          </li>

          <li
            class="page-item"
            th:classappend="${pagination.currentPage == 1} ? 'disabled' : ''"
          >
            <a
              class="page-link"
              th:href="@{/admin/certifications(page=${pagination.prevPage}, limit=${pagination.limit}, pageSize=${pagination.pageSize}, sort=${currentSort})}"
            >
              <i class="fa-solid fa-caret-left"></i>
              <span class="sr-only">Previous</span>
            </a>
          </li>

          <li
            th:each="pageNum : ${#numbers.sequence(pagination.startPage, pagination.endPage)}"
            class="page-item"
            th:classappend="${pageNum == pagination.currentPage} ? 'active' : ''"
          >
            <a
              class="page-link"
              th:href="@{/admin/certifications(page=${pageNum}, limit=${pagination.limit}, pageSize=${pagination.pageSize}, sort=${currentSort})}"
              th:text="${pageNum}"
              >1</a
            >
          </li>

          <li
            class="page-item"
            th:classappend="${pagination.currentPage == pagination.maxPage} ? 'disabled' : ''"
          >
            <a
              class="page-link"
              th:href="@{/admin/certifications(page=${pagination.nextPage}, limit=${pagination.limit}, pageSize=${pagination.pageSize}, sort=${currentSort})}"
            >
              <i class="fa-solid fa-caret-right"></i>
              <span class="sr-only">Next</span>
            </a>
          </li>

          <li
            class="page-item"
            th:classappend="${pagination.currentPage == pagination.maxPage} ? 'disabled' : ''"
          >
            <a
              class="page-link"
              th:href="@{/admin/certifications(page=${pagination.maxPage}, limit=${pagination.limit}, pageSize=${pagination.pageSize}, sort=${currentSort})}"
            >
              <i class="fa-solid fa-forward"></i>
              <span class="sr-only">Last</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- 모달 -->
      <div
        class="modal fade"
        id="certificationProcessModal"
        tabindex="-1"
        aria-labelledby="certificationProcessModalLabel"
        aria-hidden="true"
      >
        <div
          class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
        >
          <div class="modal-content">
            <div class="modal-header" style="background-color: #f8f9fa">
              <h5
                class="modal-title"
                id="certificationProcessModalLabel"
                style="font-weight: 600"
              >
                재직 인증 처리
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="info-group">
                <span class="info-label">회원 아이디</span>
                <span class="info-value" id="modalCertUserId"></span>
              </div>
              <div class="info-group">
                <span class="info-label">회사명</span>
                <span class="info-value" id="modalCertCompany"></span>
              </div>
              <div class="info-group">
                <span class="info-label">요청 날짜</span>
                <span class="info-value" id="modalCertRequestDate"></span>
              </div>

              <div class="certification-documents">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333">
                  제출 서류
                </div>
                <div id="modalCertDocuments" class="document-list">
                  <p
                    class="text-muted"
                    id="modalNoDocumentsMessage"
                    style="width: 100%; text-align: center"
                  >
                    제출된 서류가 없습니다.
                  </p>
                </div>
              </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa">
              <input type="hidden" id="modalCertificationId" value="" />
              <button
                type="button"
                class="btn btn-danger btn-sm"
                onclick="handleCertificationAction('REJECTED')"
              >
                반려
              </button>
              <button
                type="button"
                class="btn btn-primary btn-sm"
                onclick="handleCertificationAction('APPROVED')"
              >
                인증
              </button>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                data-dismiss="modal"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- image zoom -->
      <div
        class="modal fade image-zoom-modal"
        id="imageZoomModal"
        tabindex="-1"
        aria-labelledby="imageZoomModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div
            class="modal-content"
            style="background: transparent; border: none"
          >
            <div
              class="modal-header"
              style="
                border-bottom: none;
                padding: 0.5rem 1rem;
                position: absolute;
                top: 0;
                right: 0;
                z-index: 1051;
              "
            >
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
                style="
                  color: white;
                  opacity: 1;
                  font-size: 2.5rem;
                  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
                "
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <img src="" id="zoomedImage" alt="확대 이미지" />
            </div>
          </div>
        </div>
      </div>

      <div
        th:if="${successMessage}"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <span th:text="${successMessage}"></span>
        <button
          type="button"
          class="close"
          data-dismiss="alert"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div
        th:if="${errorMessage}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <span th:text="${errorMessage}"></span>
        <button
          type="button"
          class="close"
          data-dismiss="alert"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <form
        id="certificationActionForm"
        method="POST"
        style="display: none"
        th:action="@{/}"
      >
        <input
          type="hidden"
          th:name="${_csrf?.parameterName}"
          th:value="${_csrf?.token}"
        />
        <input
          type="hidden"
          name="certificationId"
          id="formCertificationId"
          value=""
        />
        <input type="hidden" name="newStatus" id="formNewStatus" value="" />
      </form>
    </main>

    <script th:src="@{/js/admin/certification.js}"></script>
  </body>
</html>
